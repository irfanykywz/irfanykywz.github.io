{{ define "head" }}
{{ end }}

{{ define "main" }}
    <div class="min-h-[calc(100vh-200px)] py-16 bg-white dark:bg-gray-900 transition-colors duration-300">
        <div class="container mx-auto px-4 max-w-4xl">
            <!-- Search Header -->
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-4 flex items-center justify-center gap-3">
                    {{ partial "icons/search.html" (dict "class" "w-10 h-10 text-indigo-600 dark:text-indigo-400") }}
                    {{ .Title }}
                </h1>
                <p class="text-xl text-gray-600 dark:text-gray-300 max-w-2xl mx-auto">{{ .Description }}</p>
            </div>

            <!-- Search Input -->
            <div class="mb-8">
                <div class="relative max-w-2xl mx-auto">
                    <input 
                        type="search" 
                        id="searchInput" 
                        class="w-full px-6 py-4 text-lg border-2 border-gray-200 dark:border-gray-700 rounded-full bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all" 
                        placeholder="Masukan kata yang ingin dicari"
                        autocomplete="off"
                    >
                    <button id="searchIcon" class="absolute right-3 top-1/2 -translate-y-1/2 p-2 text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors" aria-label="Search">
                        {{ partial "icons/search.html" (dict "class" "w-6 h-6") }}
                    </button>
                </div>
            </div>

            <!-- Search Stats -->
            <div class="flex justify-between items-center mb-8 px-4 text-sm text-gray-500 dark:text-gray-400">
                <span id="resultCount">0 hasil</span>
                <span id="searchTime"></span>
            </div>

            <!-- Search Results -->
            <div id="searchResults" class="hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
                    <table class="w-full text-left">
                        <thead>
                            <tr>
                                <th class="bg-gray-50 dark:bg-gray-700/50 px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Judul</th>
                                <th class="bg-gray-50 dark:bg-gray-700/50 px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Tanggal</th>
                                <th class="bg-gray-50 dark:bg-gray-700/50 px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Pratinjau</th>
                                <th class="bg-gray-50 dark:bg-gray-700/50 px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="searchTableBody">
                            <!-- Results will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- No Results -->
            <div id="noResults" class="hidden text-center py-20">
                <div class="max-w-md mx-auto">
                    <div class="w-16 h-16 mx-auto mb-4 text-gray-300 dark:text-gray-600">
                        {{ partial "icons/search.html" (dict "class" "w-full h-full") }}
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Hasil tidak ditemukan</h3>
                    <p class="text-gray-500 dark:text-gray-400">Coba sesuaikan kata kunci pencarian Anda atau telusuri kategori kami</p>
                </div>
            </div>

            <!-- Initial State -->
            <div id="initialState" class="text-center py-20">
                <div class="max-w-md mx-auto">
                    <div class="w-16 h-16 mx-auto mb-4 text-gray-300 dark:text-gray-600">
                        {{ partial "icons/search.html" (dict "class" "w-full h-full") }}
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Mulai Pencarian</h3>
                    <p class="text-gray-500 dark:text-gray-400">Masukkan kata kunci untuk menemukan konten yang relevan</p>
                </div>
            </div>
        </div>
    </div>

{{ end }}

{{ define "footer" }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const searchIcon = document.getElementById('searchIcon');
            const searchResults = document.getElementById('searchResults');
            const noResults = document.getElementById('noResults');
            const initialState = document.getElementById('initialState');
            const resultCount = document.getElementById('resultCount');
            const searchTime = document.getElementById('searchTime');
            
            let searchData = [];
            
            // Load JSON data
            fetch('{{ "index.json" | absURL }}')
                .then(response => response.json())
                .then(data => {
                    searchData = data;

                    // Periksa parameter URL untuk 'q' saat halaman dimuat
                    const urlParams = new URLSearchParams(window.location.search);
                    const queryFromUrl = urlParams.get('q');
                    
                    if (queryFromUrl) {
                        searchInput.value = queryFromUrl;
                        performSearch(queryFromUrl);
                    }
                })
                .catch(error => {
                    console.error('Error loading search index:', error);
                });
            
            // Search function
            function performSearch(query) {
                if (!query.trim()) {
                    searchResults.classList.add('hidden');
                    noResults.classList.add('hidden');
                    initialState.classList.remove('hidden');
                    resultCount.textContent = '0 results';
                    searchTime.textContent = '';
                    return;
                }
                
                initialState.classList.add('hidden');
                const startTime = performance.now();
                let results = searchData.filter(item => {
                    const content = `${item.title || ''} ${item.content || ''} ${item.tags || ''}`.toLowerCase();
                    return content.includes(query.toLowerCase());
                });
                
                // Hapus duplikat berdasarkan permalink
                const uniqueResults = Array.from(new Map(results.map(item => [item.permalink, item])).values());

                const endTime = performance.now();
                const searchDuration = (endTime - startTime).toFixed(2);
                
                displayResults(uniqueResults, query, searchDuration);
            }
            
            // Display results
            function displayResults(results, query, duration) {
                if (results.length === 0) {
                    searchResults.classList.add('hidden');
                    noResults.classList.remove('hidden');
                    resultCount.textContent = '0 results';
                    searchTime.textContent = `${duration}ms`;
                    return;
                }
                
                noResults.classList.add('hidden');
                searchResults.classList.remove('hidden');
                
                let resultsHTML = '';
                
                results.forEach(item => {
                    // Highlight matching text
                    const titleHighlighted = highlightText(item.title || '', query);
                    let contentPreview = item.content ? item.content.substring(0, 150) : '';
                    contentPreview = highlightText(contentPreview, query);
                    
                    // Format tags
                    let tagsHTML = '';
                    if (item.tags) {
                        const tags = item.tags.split(',').map(tag => tag.trim());
                        tagsHTML = tags.map(tag => 
                            `<span class="table-tag">${highlightText(tag, query)}</span>`
                        ).join('');
                    }
                    
                    resultsHTML += `
                        <tr>
                            <td class="px-6 py-4 border-b border-gray-100 dark:border-gray-700 last:border-0">
                                <div class="font-bold text-gray-900 dark:text-white text-lg">${titleHighlighted}</div>
                            </td>
                            <td class="px-6 py-4 border-b border-gray-100 dark:border-gray-700 last:border-0">
                                <div class="text-sm text-gray-500 dark:text-gray-400 whitespace-nowrap">${formatDate(item.date)}</div>
                            </td>
                            <!-- 
                                <td class="px-6 py-4 border-b border-gray-100 dark:border-gray-700 last:border-0">
                                    <div class="table-tags">${tagsHTML}</div>
                                </td>
                            -->
                            <td class="px-6 py-4 border-b border-gray-100 dark:border-gray-700 last:border-0">
                                <div class="text-sm text-gray-600 dark:text-gray-300 line-clamp-2">${contentPreview}...</div>
                            </td>
                            <td class="px-6 py-4 border-b border-gray-100 dark:border-gray-700 last:border-0 text-center">
                                <a href="${item.permalink}" class="inline-flex items-center gap-1 text-sm font-medium text-indigo-600 dark:text-indigo-400 hover:text-indigo-700 dark:hover:text-indigo-300">
                                    Lihat
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                                    </svg>
                                </a>
                            </td>
                        </tr>
                    `;
                });
                
                document.getElementById('searchTableBody').innerHTML = resultsHTML;
                resultCount.textContent = `${results.length} ${results.length === 1 ? 'result' : 'results'}`;
                searchTime.textContent = `${duration}ms`;
            }
            
            // Highlight matching text
            function highlightText(text, query) {
                if (!query) return text;
                
                const regex = new RegExp(query, 'gi');
                return text.replace(regex, match => `<span class="bg-yellow-200 dark:bg-yellow-900/50 text-gray-900 dark:text-white px-0.5 rounded">${match}</span>`);
            }
            
            // Format date
            function formatDate(dateString) {
                if (!dateString) {
                    return '';
                }

                // Tambahkan pemeriksaan: jika dateString mengandung '0001', anggap tidak valid.
                if (dateString.includes('0001')) {
                    return '';
                }

                const options = { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                };

                // Coba buat objek Date. Jika dateString tidak valid (misalnya, 'Invalid Date'), 
                // toLocaleDateString akan menghasilkan output yang tidak diinginkan, jadi kita harus tangani.
                const dateObject = new Date(dateString);

                if (isNaN(dateObject.getTime())) {
                    // Cek jika objek Date yang dihasilkan adalah 'Invalid Date'
                    return '';
                }

                // Gunakan 'id-ID' (Indonesia) sebagai locale untuk format Tanggal Bulan Tahun
                return dateObject.toLocaleDateString('id-ID', options);
            }
            
            // Event listeners
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    performSearch(this.value);
                }
            });
            
            searchIcon.addEventListener('click', function() {
                performSearch(searchInput.value);
            });
            
            // Debounce search for better performance
            let debounceTimer;
            searchInput.addEventListener('input', function() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    performSearch(this.value);
                }, 300);
            });
            
            // Focus search input on page load
            searchInput.focus();
        });

    </script>
{{ end }}